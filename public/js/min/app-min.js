angular.module("app",[]).service("CordovaService",["$document","$q",function(o,e){var n=e.defer(),t=!1,i=this;this.ready=n.promise,$(document).ready(function(){document.addEventListener("deviceready",function(){t=!0,n.resolve(window.cordova)})}),setTimeout(function(){t||window.cordova&&n.resolve(window.cordova)},3e3)}]).run(function(o,e){e.online=navigator.onLine,o.addEventListener("offline",function(){e.$apply(function(){e.online=!1})},!1),o.addEventListener("online",function(){e.$apply(function(){e.online=!0})},!1)}).run(["$rootScope","CordovaService","$http",function(o,e,n){function t(e){o.position=e,window.position=o.position,o.geoFinished=!0,o.lat=o.position.coords.latitude,o.long=o.position.coords.longitude,o.writeToPhone("_geoCoords",o.position.coords.latitude+"::"+o.position.coords.longitude),o.position.coords.accuracy>20?($(".dialog-geo").find("h1").text("The accuracy of your position is: "+o.position.coords.accuracy.toFixed(2)+"m. Good enough? (Turn your gps on!)"),apparitionDown($(".dialog-geo"))):(o.clearGPS(),console.log("<10"))}function i(){navigator.notification.alert("You are the winner!",alertDismissed,"Game Over","Done")}o.geoFinished=!1;var a=function(){return""!=$("input[name='timeStartParkMeter']").val()&&""!=$("input[name='timeEndParkMeter']").val()?[$("input[name='timeStartParkMeter']").val(),$("input[name='timeEndParkMeter']").val()]:""!=$("input[name='timeStartBlue']").val()?$("input[name='timeStartBlue']").val():"sry"},l=function(){$("input[name='timeStartParkMeter']").val(""),$("input[name='timeEndParkMeter']").val(""),$("input[name='timeStartBlue']").val("")},r=function(o,e){var n=parseInt(o),t=parseInt(e);return 60*n+t},c=function(o,e){return o>e?o-e:1440-(e-o)};o.parkCount=function(e){var n,t,i;if(resetCount(),2==a().length)n=a()[0].split(":"),t=r(n[0],n[1]),o.pkStart=o.toRegDate(n[0],n[1]),console.log(o.pkStart),n=a()[1].split(":"),i=r(n[0],n[1]),o.pkStop=o.toRegDate(n[0],n[1]),console.log(o.pkStop),console.log(t+" "+i+" "+c(t,i)),timer(c(t,i),1e3),l();else{if("sry"!=a()){n=a().split(":"),t=r(n[0],n[1]),o.pkStart=o.toRegDate(n[0],n[1]);var s=new Date;i=r(s.getHours(),s.getMinutes()),t=c(t,i)}else t=0;timer(e+t,1e3),l()}},o.reallyTimer=function(e){o.parkCount(e),o.geoFinished=!1,o.getPosition()},o.getPosition=function(){o.geoFinished=!1,navigator.geolocation&&(o.id=navigator.geolocation.watchPosition(t,null,{enableHighAccuracy:!0,timeout:5e3}))},o.dontGetPositionAgain=function(){disparitionUp($(".dialog-geo")),o.clearGPS()},o.getPositionAgain=function(){disparitionUp($(".dialog-geo")),setTimeout(function(){o.getPosition()},1e3)},o.clearGPS=function(){navigator.geolocation.clearWatch(o.id),disparitionUp(".dialog-geo"),console.log("gps cleared")},o.gmaps=function(){o.latlng=new google.maps.LatLng(o.lat,o.long);var e={zoom:14,center:o.latlng,disableDefaultUI:!0},n=new google.maps.Map(document.getElementById("map_canvas"),e);$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth),google.maps.event.addDomListener(window,"resize",function(){$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth)});var t=new google.maps.Marker({map:n,position:o.latlng})},$(document).on("pageshow","#map",function(e){o.gmaps(),console.log("map loaded")}),o.getDeviceName=function(){e.ready.then(function(){window.deviceName=device.platform,o.devUUID=device.uuid,console.log("dev uuid : "+o.devUUID),o.registerUUID()})},o.initRegister=function(){o.myForm={},o.myForm.name="Jacky Test",o.myForm.email="jacky@test.com",o.myForm.password="testy"},o.registerSubmit=function(){console.log("submitting..."),o.dataObject={name:o.myForm.name,email:o.myForm.email,password:o.myForm.password}},o.doComsList=function(){for(console.log("docmomlsk"),console.log(o.comsList);o.comsList.length;)o.comsList.shift().call(),console.log(o.comsList)},o.comsList=[],window.setInterval(function(){1==o.online&&o.comsList.length>0&&o.doComsList()},15e3),o.registerUUID=function(){if(1==o.online){var e={device_token:o.devUUID};console.log(e),n.post("http://ticketescape.m4kers.com/users",e).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(o,e,n,t){console.log("errorcallback"),console.log(o),console.log(e),console.log(n),console.log(t)})}else o.comsList.push(function(){o.registerUUID()})},o.registerZone=function(e,t,i){if(1==o.online){var a;"green"==e?(a={geo_lat:o.lat,geo_lon:o.long,zone:"green"},console.log(a),n.post("http://ticketescape.m4kers.com/parking",a).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(o,e,n,t){console.log("errorcallback"),console.log(o),console.log(e),console.log(n),console.log(t)})):"blue"==e?(a={geo_lat:o.lat,geo_lon:o.long,zone:"blue",timestamp_start:o.pkStart},console.log(a),n.post("http://ticketescape.m4kers.com/parking",a).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(o,e,n,t){console.log("errorcallback"),console.log(o),console.log(e),console.log(n),console.log(t)})):"orange"==e&&(a={geo_lat:o.lat,geo_lon:o.long,zone:"blue",timestamp_start:o.pkStart,timestamp_end:o.pkStop},console.log(a),n.post("http://ticketescape.m4kers.com/parking",a).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(o,e,n,t){console.log("errorcallback"),console.log(o),console.log(e),console.log(n),console.log(t)}))}else o.comsList.push(function(){o.registerZone(e,t,i)})};var s;o.pushInit=function(){e.ready.then(function(){s=window.plugins.pushNotification,console.log(" registering "+device.platform),"android"==device.platform||"Android"==device.platform||"amazon-fireos"==device.platform?s.register(successHandler,errorHandler,{senderID:"90430114137",ecb:"onNotification"}):"blackberry10"==device.platform?s.register(successHandler,errorHandler,{invokeTargetId:"replace_with_invoke_target_id",appId:"replace_with_app_id",ppgUrl:"replace_with_ppg_url",ecb:"pushNotificationHandler",simChangeCallback:replace_with_simChange_callback,pushTransportReadyCallback:replace_with_pushTransportReady_callback,launchApplicationOnPush:!0}):s.register(tokenHandler,errorHandler,{badge:"true",sound:"true",alert:"true",ecb:"onNotificationAPN"})})},o.bluetoothIsEnabled=function(){e.ready.then(function(){window.bluetooth.enable(o.isEnabled,o.onError)})},o.isEnabled=function(o){console.log(o)},o.onError=function(o){console.log(o)},o.bluetoothToggleOn=function(){e.ready.then(function(){window.bluetooth.enable(o.blSuccess,o.onError)})},o.blSuccess=function(){console.log("bluetooth successfully turned on"),o.bluetoothStartDiscovery()},o.bluetoothStartDiscovery=function(){e.ready.then(function(){window.bluetooth.startDiscovery(o.onDeviceDiscovered,o.onDiscoveryFinished,o.onError,null)})},o.onDeviceDiscovered=function(e){console.log("a device was discovered"),console.log(e.name),console.log(e.address),o.devicesMap[e.name]=e.address},o.onDiscoveryFinished=function(){console.log("dicovery finished with success"),console.log("map:"),console.log(o.devicesMap),o.bluetoothPair()},o.bluetoothPair=function(){e.ready.then(function(){for(var e in o.devicesMap)"98:D3:31:90:13:D5"==o.devicesMap[e]&&window.bluetooth.pair(o.onPairSuccess,o.onError,o.devicesMap[e])})},o.onPairSuccess=function(o){console.log("Pair sucessfull"),console.log(o)},o.loadLastCurrentData=function(){e.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,o.gotFSReader,o.fail)})},o.writeData=function(n){o.currentData={},o.currentData=n,e.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,o.gotFS,o.fail)})},o.writeDatouz=function(){e.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,o.gotFS,o.fail)})},o.gotFSReader=function(e){e.root.getFile(config.savedFile,null,o.gotFileEntryReader,o.fail)},o.gotFileEntryReader=function(e){e.file(o.gotFile,o.fail)},o.gotFile=function(e){o.readData(e)},o.readData=function(e,n){var t=new FileReader;t.onloadend=function(e){console.log("Entered Read."),o.$apply(function(){o.currentData={},o.currentData=JSON.parse(e.target.result),o.loadLast($("textarea"),o.currentData),window.rscd=o.currentData,o.firstLoad=!1})},t.readAsText(e)},o.gotFS=function(e){e.root.getFile(config.savedFile,{create:!0,exclusive:!1},o.gotFileEntry,o.fail)},o.gotFileEntry=function(e){e.createWriter(o.gotFileWriter,o.fail)},o.gotFileWriter=function(e){e.onwriteend=function(o){},e.write(JSON.stringify(o.currentData))},o.fail=function(o){console.log(1==o.code?"Error: file not found exception":2==o.code?"Error: invalid url error":"Error: connection error")},o.jsonWriteData=function(e,n){console.log("Entered jsonWriteData");var t=JSON.stringify(o.currentData);if("{}"===t)console.log(1),t='{"'+e+'":"'+n+'"}',o.writeData(JSON.parse(t));else if(-1==t.indexOf(e))console.log(2),i=t.slice(0,t.length-1),t=i+',"'+e+'":"'+n+'"}',window.tmp=t,o.writeData(JSON.parse(t));else{console.log(3);var i=t.slice(0,t.indexOf(e)+e.length+3),a=n,l=t.slice(t.indexOf(e)+e.length+3,t.length),r=l.slice(l.indexOf('"'),t.length);t=i+a+r,o.writeData(JSON.parse(t))}o.key="",o.value="",console.log("jsonWriteData finished.")},o.writeToPhone=function(e,n){console.log("Entered writeToPhone"),o.key=e,"string"==typeof n&&"."!=n.charAt(0)?(console.log(n),console.log(n.charAt(0)),o.value=n):o.value=$(n).val(),o.jsonWriteData(o.key,o.value),console.log("writeToPhone finished.")},o.loadLast=function(e,n){if(console.log("Entered loadLAst"),n._pkNotes&&e.val(n._pkNotes),n._geoCoords){var t=n._geoCoords.split("::");o.lat=parseFloat(t[0]),o.long=parseFloat(t[1]),o.geoFinished=!0}n._activePage&&"main-screen-to-park"==$.mobile.activePage.attr("id")&&"main-screen-to-park"!=n._activePage&&(window.location.href="#"+n._activePage),console.log("Finshed loadLAst")},o.goToCar=function(){console.log("entered go to car");var e=codeLatLng(o.lat,o.long)},$(document).on("pagechange",function(e){console.log($.mobile.activePage.attr("id")),0==o.firstLoad&&o.writeToPhone("_activePage",$.mobile.activePage.attr("id"))}),o.toRegDate=function(o,e){var n=o,t=e;console.log();var i=new Date;return console.log("tiiiime"),console.log(i.getFullYear()+"-"+i.getMonth()+"-"+i.getDay()+" "+n+":"+t+":00"),i.getFullYear()+"-"+i.getMonth()+"-"+i.getDay()+" "+o+":"+e+":00"},o.init=function(){var e;o.devUUID="testDeviceID",o.registerUUID(),o.devicesMap=[],o.firstLoad=!0,o.angularLoaded=!0,console.log("coucou angular"),o.currentData={},o.key="",o.value="",o.lat="",o.long="",o.loadLastCurrentData(),o.bluetoothIsEnabled(),o.bluetoothToggleOn(),i()},o.init()}]);