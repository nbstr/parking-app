angular.module("app",[]).service("CordovaService",["$document","$q",function(o,e){var n=e.defer(),t=!1,i=this;this.ready=n.promise,$(document).ready(function(){document.addEventListener("deviceready",function(){t=!0,n.resolve(window.cordova)})}),setTimeout(function(){t||window.cordova&&n.resolve(window.cordova)},3e3)}]).run(["$window","$rootScope","CordovaService","$http",function(o,e,n,t){function i(o){e.position=o,window.position=e.position,e.geoFinished=!0,e.lat=e.position.coords.latitude,e.long=e.position.coords.longitude,e.writeToPhone("_geoCoords",e.position.coords.latitude+"::"+e.position.coords.longitude),e.position.coords.accuracy>20?($(".dialog-geo").find("h1").text("The accuracy of your position is: "+e.position.coords.accuracy.toFixed(2)+"m. Good enough? (Turn your gps on!)"),apparitionDown($(".dialog-geo"))):(e.clearGPS(),console.log("<10"))}function l(){alert("Dismissed!")}function a(o){if(o.alert&&navigator.notification.alert(o.alert),o.sound){var e=new Media(o.sound);e.play()}o.badge&&u.setApplicationIconBadgeNumber(successHandler,errorHandler,o.badge)}e.geoFinished=!1,e.online=navigator.onLine,o.addEventListener("offline",function(){e.$apply(function(){e.online=!1})},!1),o.addEventListener("online",function(){e.$apply(function(){e.online=!0})},!1);var r=function(){return""!=$("input[name='timeStartParkMeter']").val()&&""!=$("input[name='timeEndParkMeter']").val()?[$("input[name='timeStartParkMeter']").val(),$("input[name='timeEndParkMeter']").val()]:""!=$("input[name='timeStartBlue']").val()?$("input[name='timeStartBlue']").val():""!=$("input[name='timeStartRed']").val()?$("input[name='timeStartRed']").val():"sry"},c=function(){$("input[name='timeStartParkMeter']").val(""),$("input[name='timeEndParkMeter']").val(""),$("input[name='timeStartBlue']").val("")},s=function(o,e){var n=parseInt(o),t=parseInt(e);return 60*n+t},g=function(o,e){return o>=e?o-e:1440-(e-o)};e.parkCount=function(o){var n,t,i,l;if(resetCount(),console.log(r()),2==r().length)n=r()[0].split(":"),t=s(n[0],n[1]),e.pkStart=e.toRegDate(n[0],n[1]),console.log(e.pkStart),n=r()[1].split(":"),i=s(n[0],n[1]),e.pkStop=e.toRegDate(n[0],n[1]),console.log(e.pkStop),console.log(t+" "+i+" "+g(t,i)),l=g(t,i),timer(l,1e3),c();else{if("sry"!=r()){n=r().split(":"),t=s(n[0],n[1]),e.pkStart=e.toRegDate(n[0],n[1]);var a=new Date;i=s(a.getHours(),a.getMinutes()),t=g(t,i)}else t=0;l=o+t,timer(l,1e3),c()}e.notificationCancelAll(),l>30&&e.allAlerts(1,"Time's nearly up!","There is 30 mins left!",1e3*(l-30)),e.allAlerts(2,"Time's nearly up!","There is only 5 mins left!",1e3*(l-5))},e.reallyTimer=function(o){e.parkCount(o),e.geoFinished=!1,e.getPosition()},e.getPosition=function(){e.geoFinished=!1,navigator.geolocation&&(e.id=navigator.geolocation.watchPosition(i,null,{enableHighAccuracy:!0,timeout:5e3}))},e.dontGetPositionAgain=function(){disparitionUp($(".dialog-geo")),e.clearGPS()},e.getPositionAgain=function(){disparitionUp($(".dialog-geo")),setTimeout(function(){e.getPosition()},1e3)},e.clearGPS=function(){navigator.geolocation.clearWatch(e.id),disparitionUp(".dialog-geo"),console.log("gps cleared")},e.gmaps=function(){e.latlng=new google.maps.LatLng(e.lat,e.long);var o={zoom:14,center:e.latlng,disableDefaultUI:!0},n=new google.maps.Map(document.getElementById("map_canvas"),o);$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth),google.maps.event.addDomListener(window,"resize",function(){$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth)});var t=new google.maps.Marker({map:n,position:e.latlng})},$(document).on("pageshow","#map",function(o){e.gmaps(),console.log("map loaded")}),e.getDeviceName=function(){n.ready.then(function(){window.deviceName=device.platform,e.devUUID=device.uuid,console.log("dev uuid : "+e.devUUID),e.registerUUID()})},e.doComsList=function(){for(console.log("docmomlsk"),console.log(e.comsList);e.comsList.length;){var o=e.comsList.shift();"regzone"==o.func?(e.pkStart=o.time1,e.pkStop=o.time2,e.registerZone(o.color)):"uuid"==o.func&&e.registerUUID(),console.log(e.comsList)}},e.comsList=[],e.storeComsList=function(){e.writeToPhone("_comsList",e.comsList)},e.registerRegID=function(o){if(1==e.online){var n={device_token:e.devUUID,device_notification_token:o,app_name:"TicketEscape_droid"};console.log(n),t.post("http://ticketescape.m4kers.com/users/registration_id",n).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(o,e,n,t){console.log("errorcallback"),console.log(o),console.log(e),console.log(n),console.log(t)})}else e.comsList.push({func:"regid"}),e.storeComsList()},e.registerUUID=function(){if(1==e.online){var o={device_token:e.devUUID};console.log(o),t.post("http://ticketescape.m4kers.com/users",o).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(o,e,n,t){console.log("errorcallback"),console.log(o),console.log(e),console.log(n),console.log(t)})}else e.comsList.push({func:"uuid"}),e.storeComsList()},e.registerZone=function(o){var n=new Date;if(e.color=o,1==e.online){var i;"green"==o?(i={geo_lat:e.lat,geo_lon:e.long,zone:"green"},console.log(i),t.post("http://ticketescape.m4kers.com/parking",i).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(n,t,i,l){console.log("errorcallback"),console.log(n),console.log(t),console.log(i),console.log(l),console.log("error, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()})):"blue"==o?(void 0==e.pkStart&&(e.pkStart=e.toRegDate(n.getHours(),n.getMinutes())),i={geo_lat:e.lat,geo_lon:e.long,zone:"blue",timestamp_start:e.pkStart},console.log(i),t.post("http://ticketescape.m4kers.com/parking",i).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(n,t,i,l){console.log("errorcallback"),console.log(n),console.log(t),console.log(i),console.log(l),console.log("error, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()})):"orange"==o&&(void 0==e.pkStart&&(e.pkStart=e.toRegDate(n.getHours(),n.getMinutes())),(e.pkStop=void 0)&&(e.pkStop="undefined"),i={geo_lat:e.lat,geo_lon:e.long,zone:"blue",timestamp_start:e.pkStart,timestamp_end:e.pkStop},console.log(i),t.post("http://ticketescape.m4kers.com/parking",i).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(n,t,i,l){console.log("errorcallback"),console.log(n),console.log(t),console.log(i),console.log(l),console.log("error, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()}))}else console.log("offline, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()},e.allAlerts=function(o,n,t,i){setTimeout(function(){e.vibrate();var i=new Date;e.notificationAdd(o,n,t)},i)},e.showAlert=function(){console.log("should show alert"),navigator.notification.alert("You are the winner!",l,"Game Over","Done")},e.playBeep=function(){console.log("should play beep"),navigator.notification.beep(3)},e.vibrate=function(){console.log("should vibrate"),navigator.notification.vibrate(2e3)},e.notificationCancelAll=function(){window.plugin.notification.local.cancelAll(function(){console.log("canceled all")})},e.notificationAdd=function(o,e,t){n.ready.then(function(){window.plugin.notification.local.add({id:o,message:t,title:e,autoCancel:!0,ongoing:!1})})},e.notificationhasPermission=function(){n.ready.then(function(){window.plugin.notification.local.hasPermission(function(o){console.log("Permission has been granted: "+o),console.log(window.plugin.notification.local)})})};var u;e.pushInit=function(){n.ready.then(function(){document.addEventListener("deviceready",function(){u=window.plugins.pushNotification})})},e.pushRegister=function(){n.ready.then(function(){console.log(" registering "+device.platform),"android"==device.platform||"Android"==device.platform||"amazon-fireos"==device.platform?(console.log("is an android"),u.register(e.successHandler,e.errorHandler,{senderID:"1041626889289",ecb:"onNotification"})):"blackberry10"==device.platform?u.register(e.successHandler,e.errorHandler,{invokeTargetId:"replace_with_invoke_target_id",appId:"replace_with_app_id",ppgUrl:"replace_with_ppg_url",ecb:"pushNotificationHandler",simChangeCallback:replace_with_simChange_callback,pushTransportReadyCallback:replace_with_pushTransportReady_callback,launchApplicationOnPush:!0}):u.register(e.tokenHandler,e.errorHandler,{badge:"true",sound:"true",alert:"true",ecb:"onNotificationAPN"})})},e.successHandler=function(o){console.log("result = "+o)},e.errorHandler=function(o){console.log("error = "+o)},window.onNotification=function(o){switch(console.log("app status 'received' :"+o.event),o.event){case"registered":o.regid.length>0&&(console.log("app status 'registered' :"+o.regid),console.log("regID = "+o.regid),e.registerRegID(o.regid));break;case"message":if(o.foreground){console.log("app status 'inline notification' :"+o.regid);var n=o.soundname||o.payload.sound,t=new Media("/android_asset/www/"+n);t.play()}else console.log(o.coldstart?"COLDSTART NOTIFICATION":"BACKGROUND NOTIFICATION");console.log("MESSAGE -> MSG: "+o.payload.message),console.log("MESSAGE -> MSGCNT: "+o.payload.msgcnt),console.log("MESSAGE -> TIME: "+o.payload.timeStamp);break;case"error":console.log("ERROR -> MSG:"+o.msg);break;default:console.log("EVENT -> Unknown, an event was received and we do not know what it is")}},e.tokenHandler=function(o){alert("device token = "+o)},e.bluetoothIsEnabled=function(){n.ready.then(function(){window.bluetooth.enable(e.isEnabled,e.onError)})},e.isEnabled=function(o){console.log(o)},e.onError=function(o){console.log(o)},e.bluetoothToggleOn=function(){n.ready.then(function(){window.bluetooth.enable(e.blSuccess,e.onError)})},e.blSuccess=function(){console.log("bluetooth successfully turned on"),e.bluetoothStartDiscovery(null)},e.bluetoothStartDiscovery=function(o){n.ready.then(function(){window.bluetooth.startDiscovery(e.onDeviceDiscovered,e.onDiscoveryFinished,e.onError,o)})},e.onDeviceDiscovered=function(o){console.log("a device was discovered"),console.log(o.name),console.log(o.address),e.devicesMap[o.name]=o.address},e.onDiscoveryFinished=function(){console.log("dicovery finished with success"),console.log("map:"),console.log(e.devicesMap)},e.bluetoothIsPaired=function(o){n.ready.then(function(){window.bluetooth.isPaired(e.onResult,e.onError,o)})},e.onResult=function(o){console.log("on Result"),console.log(o)},e.bluetoothPair=function(o){n.ready.then(function(){window.bluetooth.pair(e.onDevicePaired,e.onError,o)})},e.onDevicePaired=function(o){console.log("device paired?"),console.log(o)},e.bluetoothPair=function(){n.ready.then(function(){for(var o in e.devicesMap)"98:D3:31:90:13:D5"==e.devicesMap[o]&&window.bluetooth.pair(e.onPairSuccess,e.onError,e.devicesMap[o])})},e.onPairSuccess=function(o){console.log("Pair sucessfull"),console.log(o)},e.bluetoothIsConnected=function(o){n.ready.then(function(){window.bluetooth.isConnected(e.onResult,e.onError)})},e.bluetoothIsConnectionManaged=function(o){n.ready.then(function(){window.bluetooth.isConnectionManaged(e.onResult,e.onError)})},e.bluetoothConnect=function(o){n.ready.then(function(){window.bluetooth.connect(e.onBluetoothConnected,e.onError,o)})},e.onBluetoothConnected=function(o){console.log("isConnected?"),console.log(o)},e.loadLastCurrentData=function(){n.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e.gotFSReader,e.fail)})},e.writeData=function(o){e.currentData={},e.currentData=o,n.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e.gotFS,e.fail)})},e.writeDatouz=function(){n.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e.gotFS,e.fail)})},e.gotFSReader=function(o){o.root.getFile(config.savedFile,null,e.gotFileEntryReader,e.fail)},e.gotFileEntryReader=function(o){o.file(e.gotFile,e.fail)},e.gotFile=function(o){e.readData(o)},e.readData=function(o,n){var t=new FileReader;t.onloadend=function(o){console.log("Entered Read."),e.$apply(function(){console.log(o.target.result),e.currentData={},o.target.result&&(e.currentData=JSON.parse(o.target.result),e.loadLast($("textarea"),e.currentData)),e.firstLoad=!1})},t.readAsText(o)},e.gotFS=function(o){o.root.getFile(config.savedFile,{create:!0,exclusive:!1},e.gotFileEntry,e.fail)},e.gotFileEntry=function(o){o.createWriter(e.gotFileWriter,e.fail)},e.gotFileWriter=function(o){o.onwriteend=function(o){},o.write(JSON.stringify(e.currentData))},e.fail=function(o){console.log(1==o.code?"Error: file not found exception":2==o.code?"Error: invalid url error":"Error: connection error")},e.jsonWriteData=function(o,n){console.log("Entered jsonWriteData");var t=JSON.stringify(e.currentData);if("{}"===t)console.log(1),t='{"'+o+'":"'+n+'"}',e.writeData(JSON.parse(t));else if(-1==t.indexOf(o))console.log(2),i=t.slice(0,t.length-1),t=i+',"'+o+'":"'+n+'"}',window.tmp=t,e.writeData(JSON.parse(t));else{console.log(3);var i=t.slice(0,t.indexOf(o)+o.length+3),l=n,a=t.slice(t.indexOf(o)+o.length+3,t.length),r=a.slice(a.indexOf('"'),t.length);t=i+l+r,console.log(i),console.log(l),console.log(r),console.log(t),e.writeData(JSON.parse(t))}e.key="",e.value="",console.log("jsonWriteData finished.")},e.writeToPhone=function(o,n){var t="";if(console.log("Entered writeToPhone"),e.key=o,"string"==typeof n&&"."!=n.charAt(0))console.log(n),console.log(n.charAt(0)),e.value=n;else if(n.constructor===Array){console.log("its an array");for(var i=0;i<n.length;i++){console.log(n[i]),t+=JSON.stringify(n[i]);var l="'"+t+"'";e.value=l}console.log(t)}else e.value=$(n).val();e.jsonWriteData(e.key,e.value),console.log("writeToPhone finished.")},e.loadLast=function(o,n){if(console.log("Entered loadLAst"),n._pkNotes&&o.val(n._pkNotes),n._geoCoords){var t=n._geoCoords.split("::");e.lat=parseFloat(t[0]),e.long=parseFloat(t[1]),e.geoFinished=!0}n._activePage&&"main-screen-to-park"==$.mobile.activePage.attr("id")&&"main-screen-to-park"!=n._activePage&&(window.location.href="#"+n._activePage),n._comsList&&(e.comsList=n._comsList),console.log("Finshed loadLAst")},e.goToCar=function(){console.log("entered go to car");var o=codeLatLng(e.lat,e.long)},$(document).on("pagechange",function(o){console.log($.mobile.activePage.attr("id")),0==e.firstLoad&&e.writeToPhone("_activePage",$.mobile.activePage.attr("id"))}),e.toRegDate=function(o,e){var n=o,t=e;console.log();var i=new Date;return console.log("tiiiime"),console.log(i.getFullYear()+"-"+i.getMonth()+"-"+i.getDay()+" "+n+":"+t+":00"),i.getFullYear()+"-"+i.getMonth()+"-"+i.getDay()+" "+o+":"+e+":00"},e.init=function(){var o;e.getDeviceName(),e.registerUUID(),e.devicesMap=[],e.firstLoad=!0,e.angularLoaded=!0,console.log("coucou angular"),e.currentData={},e.key="",e.value="",e.lat="",e.long="",e.loadLastCurrentData(),e.bluetoothIsEnabled(),e.bluetoothToggleOn(),e.notificationhasPermission(),e.pushInit(),e.pushRegister()},e.init()}]);