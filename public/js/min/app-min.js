angular.module("app",[]).service("CordovaService",["$document","$q",function(o,e){var n=e.defer(),t=!1,i=this;this.ready=n.promise,$(document).ready(function(){document.addEventListener("deviceready",function(){t=!0,n.resolve(window.cordova)})}),setTimeout(function(){t||window.cordova&&n.resolve(window.cordova)},3e3)}]).run(["$window","$rootScope","CordovaService","$http",function(o,e,n,t){function i(o){e.position=o,window.position=e.position,e.geoFinished=!0,e.lat=e.position.coords.latitude,e.long=e.position.coords.longitude,e.writeToPhone("_geoCoords",e.position.coords.latitude+"::"+e.position.coords.longitude),e.position.coords.accuracy>20?($(".dialog-geo").find("h1").text("The accuracy of your position is: "+e.position.coords.accuracy.toFixed(2)+"m. Good enough? (Turn your gps on!)"),apparitionDown($(".dialog-geo"))):(e.clearGPS(),console.log("<10"))}function a(){alert("Dismissed!")}e.geoFinished=!1,e.online=navigator.onLine,o.addEventListener("offline",function(){e.$apply(function(){e.online=!1})},!1),o.addEventListener("online",function(){e.$apply(function(){e.online=!0})},!1);var l=function(){return""!=$("input[name='timeStartParkMeter']").val()&&""!=$("input[name='timeEndParkMeter']").val()?[$("input[name='timeStartParkMeter']").val(),$("input[name='timeEndParkMeter']").val()]:""!=$("input[name='timeStartBlue']").val()?$("input[name='timeStartBlue']").val():"sry"},r=function(){$("input[name='timeStartParkMeter']").val(""),$("input[name='timeEndParkMeter']").val(""),$("input[name='timeStartBlue']").val("")},s=function(o,e){var n=parseInt(o),t=parseInt(e);return 60*n+t},c=function(o,e){return o>=e?o-e:1440-(e-o)};e.parkCount=function(o){var n,t,i,a;if(resetCount(),2==l().length)n=l()[0].split(":"),t=s(n[0],n[1]),e.pkStart=e.toRegDate(n[0],n[1]),console.log(e.pkStart),n=l()[1].split(":"),i=s(n[0],n[1]),e.pkStop=e.toRegDate(n[0],n[1]),console.log(e.pkStop),console.log(t+" "+i+" "+c(t,i)),a=c(t,i),timer(a,1e3),r();else{if("sry"!=l()){n=l().split(":"),t=s(n[0],n[1]),e.pkStart=e.toRegDate(n[0],n[1]);var g=new Date;i=s(g.getHours(),g.getMinutes()),t=c(t,i)}else t=0;a=o+t,timer(a,1e3),r()}a>30&&e.allAlerts(1,"Time's nearly up!","There is 30 mins left!",1e3*(a-30)),e.allAlerts(2,"Time's nearly up!","There is only 5 mins left!",1e3*(a-5))},e.reallyTimer=function(o){e.parkCount(o),e.geoFinished=!1,e.getPosition()},e.getPosition=function(){e.geoFinished=!1,navigator.geolocation&&(e.id=navigator.geolocation.watchPosition(i,null,{enableHighAccuracy:!0,timeout:5e3}))},e.dontGetPositionAgain=function(){disparitionUp($(".dialog-geo")),e.clearGPS()},e.getPositionAgain=function(){disparitionUp($(".dialog-geo")),setTimeout(function(){e.getPosition()},1e3)},e.clearGPS=function(){navigator.geolocation.clearWatch(e.id),disparitionUp(".dialog-geo"),console.log("gps cleared")},e.gmaps=function(){e.latlng=new google.maps.LatLng(e.lat,e.long);var o={zoom:14,center:e.latlng,disableDefaultUI:!0},n=new google.maps.Map(document.getElementById("map_canvas"),o);$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth),google.maps.event.addDomListener(window,"resize",function(){$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth)});var t=new google.maps.Marker({map:n,position:e.latlng})},$(document).on("pageshow","#map",function(o){e.gmaps(),console.log("map loaded")}),e.getDeviceName=function(){n.ready.then(function(){window.deviceName=device.platform,e.devUUID=device.uuid,console.log("dev uuid : "+e.devUUID),e.registerUUID()})},e.initRegister=function(){e.myForm={},e.myForm.name="Jacky Test",e.myForm.email="jacky@test.com",e.myForm.password="testy"},e.registerSubmit=function(){console.log("submitting..."),e.dataObject={name:e.myForm.name,email:e.myForm.email,password:e.myForm.password}},e.doComsList=function(){for(console.log("docmomlsk"),console.log(e.comsList);e.comsList.length;){var o=e.comsList.shift();"regzone"==o.func?(e.pkStart=o.time1,e.pkStop=o.time2,e.registerZone(o.color)):"uuid"==o.func&&e.registerUUID(),console.log(e.comsList)}},e.comsList=[],e.storeComsList=function(){},window.setInterval(function(){console.log("interval"),e.loadLastCurrentData(),1==e.online&&e.comsList.length>0&&e.doComsList()},1e4),e.registerUUID=function(){if(1==e.online){var o={device_token:e.devUUID};console.log(o),t.post("http://ticketescape.m4kers.com/users",o).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(o,e,n,t){console.log("errorcallback"),console.log(o),console.log(e),console.log(n),console.log(t)})}else e.comsList.push({func:"uuid"}),e.storeComsList()},e.registerZone=function(o){var n=new Date;if(e.color=o,1==e.online){var i;"green"==o?(i={geo_lat:e.lat,geo_lon:e.long,zone:"green"},console.log(i),t.post("http://ticketescape.m4kers.com/parking",i).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(n,t,i,a){console.log("errorcallback"),console.log(n),console.log(t),console.log(i),console.log(a),console.log("error, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()})):"blue"==o?(void 0==e.pkStart&&(e.pkStart=e.toRegDate(n.getHours,n.getMinutes)),i={geo_lat:e.lat,geo_lon:e.long,zone:"blue",timestamp_start:e.pkStart},console.log(i),t.post("http://ticketescape.m4kers.com/parking",i).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(n,t,i,a){console.log("errorcallback"),console.log(n),console.log(t),console.log(i),console.log(a),console.log("error, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()})):"orange"==o&&(void 0==e.pkStart&&(e.pkStart=e.toRegDate(n.getHours,n.getMinutes)),(e.pkStop=void 0)&&(e.pkStop="undefined"),i={geo_lat:e.lat,geo_lon:e.long,zone:"blue",timestamp_start:e.pkStart,timestamp_end:e.pkStop},console.log(i),t.post("http://ticketescape.m4kers.com/parking",i).success(function(o,e,n,t){console.log("succescallback"),console.log(o),console.log(e),console.log(n),console.log(t)}).error(function(n,t,i,a){console.log("errorcallback"),console.log(n),console.log(t),console.log(i),console.log(a),console.log("error, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()}))}else console.log("offline, puttin in array"),e.comsList.push({func:"regzone",color:o,time1:e.pkStart,time2:e.pkStop}),e.storeComsList()},e.allAlerts=function(o,n,t,i){setTimeout(function(){e.vibrate();var i=new Date;e.notificationAdd(o,n,t)},i)},e.showAlert=function(){console.log("should show alert"),navigator.notification.alert("You are the winner!",a,"Game Over","Done")},e.playBeep=function(){console.log("should play beep"),navigator.notification.beep(3)},e.vibrate=function(){console.log("should vibrate"),navigator.notification.vibrate(2e3)},e.notificationAdd=function(o,e,t){n.ready.then(function(){window.plugin.notification.local.add({id:o,message:t,title:e,autoCancel:!0,ongoing:!1})})},e.notificationhasPermission=function(){n.ready.then(function(){window.plugin.notification.local.hasPermission(function(o){console.log("Permission has been granted: "+o),console.log(window.plugin.notification.local)})})};var g;e.pushInit=function(){n.ready.then(function(){g=window.plugins.pushNotification,console.log(" registering "+device.platform),"android"==device.platform||"Android"==device.platform||"amazon-fireos"==device.platform?g.register(successHandler,errorHandler,{senderID:"90430114137",ecb:"onNotification"}):"blackberry10"==device.platform?g.register(successHandler,errorHandler,{invokeTargetId:"replace_with_invoke_target_id",appId:"replace_with_app_id",ppgUrl:"replace_with_ppg_url",ecb:"pushNotificationHandler",simChangeCallback:replace_with_simChange_callback,pushTransportReadyCallback:replace_with_pushTransportReady_callback,launchApplicationOnPush:!0}):g.register(tokenHandler,errorHandler,{badge:"true",sound:"true",alert:"true",ecb:"onNotificationAPN"})})},e.bluetoothIsEnabled=function(){n.ready.then(function(){window.bluetooth.enable(e.isEnabled,e.onError)})},e.isEnabled=function(o){console.log(o)},e.onError=function(o){console.log(o)},e.bluetoothToggleOn=function(){n.ready.then(function(){window.bluetooth.enable(e.blSuccess,e.onError)})},e.blSuccess=function(){console.log("bluetooth successfully turned on"),e.bluetoothStartDiscovery()},e.bluetoothStartDiscovery=function(){n.ready.then(function(){window.bluetooth.startDiscovery(e.onDeviceDiscovered,e.onDiscoveryFinished,e.onError,null)})},e.onDeviceDiscovered=function(o){console.log("a device was discovered"),console.log(o.name),console.log(o.address),e.devicesMap[o.name]=o.address},e.onDiscoveryFinished=function(){console.log("dicovery finished with success"),console.log("map:"),console.log(e.devicesMap),e.bluetoothPair()},e.bluetoothPair=function(){n.ready.then(function(){for(var o in e.devicesMap)"98:D3:31:90:13:D5"==e.devicesMap[o]&&window.bluetooth.pair(e.onPairSuccess,e.onError,e.devicesMap[o])})},e.onPairSuccess=function(o){console.log("Pair sucessfull"),console.log(o)},e.loadLastCurrentData=function(){n.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e.gotFSReader,e.fail)})},e.writeData=function(o){e.currentData={},e.currentData=o,n.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e.gotFS,e.fail)})},e.writeDatouz=function(){n.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e.gotFS,e.fail)})},e.gotFSReader=function(o){o.root.getFile(config.savedFile,null,e.gotFileEntryReader,e.fail)},e.gotFileEntryReader=function(o){o.file(e.gotFile,e.fail)},e.gotFile=function(o){e.readData(o)},e.readData=function(o,n){var t=new FileReader;t.onloadend=function(o){console.log("Entered Read."),e.$apply(function(){console.log(o.target.result),e.currentData={},e.currentData=JSON.parse(o.target.result),e.loadLast($("textarea"),e.currentData),window.rscd=e.currentData,e.firstLoad=!1})},t.readAsText(o)},e.gotFS=function(o){o.root.getFile(config.savedFile,{create:!0,exclusive:!1},e.gotFileEntry,e.fail)},e.gotFileEntry=function(o){o.createWriter(e.gotFileWriter,e.fail)},e.gotFileWriter=function(o){o.onwriteend=function(o){},o.write(JSON.stringify(e.currentData))},e.fail=function(o){console.log(1==o.code?"Error: file not found exception":2==o.code?"Error: invalid url error":"Error: connection error")},e.jsonWriteData=function(o,n){console.log("Entered jsonWriteData");var t=JSON.stringify(e.currentData);if("{}"===t)console.log(1),t='{"'+o+'":"'+n+'"}',e.writeData(JSON.parse(t));else if(-1==t.indexOf(o))console.log(2),i=t.slice(0,t.length-1),t=i+',"'+o+'":"'+n+'"}',window.tmp=t,e.writeData(JSON.parse(t));else{console.log(3);var i=t.slice(0,t.indexOf(o)+o.length+3),a=n,l=t.slice(t.indexOf(o)+o.length+3,t.length),r=l.slice(l.indexOf('"'),t.length);t=i+a+r,console.log(i),console.log(a),console.log(r),console.log(t),e.writeData(JSON.parse(t))}e.key="",e.value="",console.log("jsonWriteData finished.")},e.writeToPhone=function(o,n){var t="";if(console.log("Entered writeToPhone"),e.key=o,"string"==typeof n&&"."!=n.charAt(0))console.log(n),console.log(n.charAt(0)),e.value=n;else if(n.constructor===Array){console.log("its an array");for(var i=0;i<n.length;i++)console.log(n[i]),t+=JSON.stringify(n[i]),e.value=t;console.log(t)}else e.value=$(n).val();e.jsonWriteData(e.key,e.value),console.log("writeToPhone finished.")},e.loadLast=function(o,n){if(console.log("Entered loadLAst"),n._pkNotes&&o.val(n._pkNotes),n._geoCoords){var t=n._geoCoords.split("::");e.lat=parseFloat(t[0]),e.long=parseFloat(t[1]),e.geoFinished=!0}n._activePage&&"main-screen-to-park"==$.mobile.activePage.attr("id")&&"main-screen-to-park"!=n._activePage&&(window.location.href="#"+n._activePage),console.log("Finshed loadLAst")},e.goToCar=function(){console.log("entered go to car");var o=codeLatLng(e.lat,e.long)},$(document).on("pagechange",function(o){console.log($.mobile.activePage.attr("id")),0==e.firstLoad&&e.writeToPhone("_activePage",$.mobile.activePage.attr("id"))}),e.toRegDate=function(o,e){var n=o,t=e;console.log();var i=new Date;return console.log("tiiiime"),console.log(i.getFullYear()+"-"+i.getMonth()+"-"+i.getDay()+" "+n+":"+t+":00"),i.getFullYear()+"-"+i.getMonth()+"-"+i.getDay()+" "+o+":"+e+":00"},e.init=function(){var o;e.devUUID="testDeviceID",e.registerUUID(),e.devicesMap=[],e.firstLoad=!0,e.angularLoaded=!0,console.log("coucou angular"),e.currentData={},e.key="",e.value="",e.lat="",e.long="",e.loadLastCurrentData(),e.bluetoothIsEnabled(),e.bluetoothToggleOn(),e.notificationhasPermission()},e.init()}]);