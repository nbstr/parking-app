angular.module("app",[]).service("CordovaService",["$document","$q",function(o,e){var n=e.defer(),t=!1,i=this;this.ready=n.promise,$(document).ready(function(){document.addEventListener("deviceready",function(){t=!0,n.resolve(window.cordova)})}),setTimeout(function(){t||window.cordova&&n.resolve(window.cordova)},3e3)}]).run(function(o,e){e.online=navigator.onLine,o.addEventListener("offline",function(){e.$apply(function(){e.online=!1})},!1),o.addEventListener("online",function(){e.$apply(function(){e.online=!0})},!1)}).run(["$rootScope","CordovaService","$http",function(o,e,n){function t(e){o.position=e,window.position=o.position,o.geoFinished=!0,o.writeToPhone("_geoCoords",o.position.coords.latitude+"::"+o.position.coords.longitude),o.position.coords.accuracy>20?($(".dialog-geo").find("h1").text("The accuracy of your position is: "+o.position.coords.accuracy.toFixed(2)+"m. Good enough? (Turn your gps on!)"),apparitionDown($(".dialog-geo"))):(o.clearGPS(),console.log("<10"))}o.geoFinished=!1,o.reallyTime=function(){parkCount(),o.geoFinished=!1,o.getPosition()},o.reallyTimer=function(e,n){timer(e,n),o.geoFinished=!1,o.getPosition()},o.getPosition=function(){o.geoFinished=!1,navigator.geolocation&&(o.id=navigator.geolocation.watchPosition(t,null,{enableHighAccuracy:!0,timeout:5e3}))},o.getPositionAgain=function(){disparitionUp($(".dialog-geo")),setTimeout(function(){o.getPosition()},1e3)},o.clearGPS=function(){navigator.geolocation.clearWatch(o.id),disparitionUp(".dialog-geo"),console.log("gps cleared")},o.gmaps=function(){o.latlng=new google.maps.LatLng(o.lat,o.long);var e={zoom:14,center:o.latlng,disableDefaultUI:!0},n=new google.maps.Map(document.getElementById("map_canvas"),e);$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth),google.maps.event.addDomListener(window,"resize",function(){$("#map_canvas").css("height",window.innerHeight).css("width",window.innerWidth)});var t=new google.maps.Marker({map:n,position:o.latlng})},$(document).on("pageshow","#map",function(e){o.gmaps(),console.log("map loaded")}),o.getDeviceName=function(){e.ready.then(function(){window.deviceName=device.platform})},o.bluetoothIsEnabled=function(){e.ready.then(function(){window.bluetooth.enable(o.isEnabled,o.onError)})},o.isEnabled=function(o){console.log(o)},o.onError=function(o){console.log(o)},o.bluetoothToggleOn=function(){e.ready.then(function(){window.bluetooth.enable(o.blSuccess,o.onError)})},o.blSuccess=function(){console.log("bluetooth successfully turned on"),o.bluetoothStartDiscovery()},o.bluetoothStartDiscovery=function(){e.ready.then(function(){window.bluetooth.startDiscovery(o.onDeviceDiscovered,o.onDiscoveryFinished,o.onError,null)})},o.onDeviceDiscovered=function(e){console.log("a device was discovered"),console.log(e.name),console.log(e.address),o.devicesMap[e.name]=e.address},o.onDiscoveryFinished=function(){console.log("dicovery finished with success"),console.log("map:"),console.log(o.devicesMap)},o.loadLastCurrentData=function(){e.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,o.gotFSReader,o.fail)})},o.writeData=function(n){o.currentData={},o.currentData=n,e.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,o.gotFS,o.fail)})},o.writeDatouz=function(){e.ready.then(function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,o.gotFS,o.fail)})},o.gotFSReader=function(e){e.root.getFile(config.savedFile,null,o.gotFileEntryReader,o.fail)},o.gotFileEntryReader=function(e){e.file(o.gotFile,o.fail)},o.gotFile=function(e){o.readData(e)},o.readData=function(e,n){var t=new FileReader;t.onloadend=function(e){console.log("Entered Read."),o.$apply(function(){o.currentData={},o.currentData=JSON.parse(e.target.result),o.loadLast($("textarea"),o.currentData),window.rscd=o.currentData,o.firstLoad=!1})},t.readAsText(e)},o.gotFS=function(e){e.root.getFile(config.savedFile,{create:!0,exclusive:!1},o.gotFileEntry,o.fail)},o.gotFileEntry=function(e){e.createWriter(o.gotFileWriter,o.fail)},o.gotFileWriter=function(e){e.onwriteend=function(o){},e.write(JSON.stringify(o.currentData))},o.fail=function(o){console.log(1==o.code?"Error: file not found exception":2==o.code?"Error: invalid url error":"Error: connection error")},o.jsonWriteData=function(e,n){console.log("Entered jsonWriteData");var t=JSON.stringify(o.currentData);if("{}"===t)console.log(1),t='{"'+e+'":"'+n+'"}',o.writeData(JSON.parse(t));else if(-1==t.indexOf(e))console.log(2),i=t.slice(0,t.length-1),t=i+',"'+e+'":"'+n+'"}',window.tmp=t,o.writeData(JSON.parse(t));else{console.log(3);var i=t.slice(0,t.indexOf(e)+e.length+3),a=n,r=t.slice(t.indexOf(e)+e.length+3,t.length),l=r.slice(r.indexOf('"'),t.length);t=i+a+l,o.writeData(JSON.parse(t))}o.key="",o.value="",console.log("jsonWriteData finished.")},o.writeToPhone=function(e,n){console.log("Entered writeToPhone"),o.key=e,"string"==typeof n&&"."!=n.charAt(0)?(console.log(n),console.log(n.charAt(0)),o.value=n):o.value=$(n).val(),o.jsonWriteData(o.key,o.value),console.log("writeToPhone finished.")},o.loadLast=function(e,n){if(console.log("Entered loadLAst"),n._pkNotes&&e.val(n._pkNotes),n._geoCoords){var t=n._geoCoords.split("::");o.lat=parseFloat(t[0]),o.long=parseFloat(t[1]),o.geoFinished=!0}n._activePage&&"main-screen-to-park"==$.mobile.activePage.attr("id")&&"main-screen-to-park"!=n._activePage&&(window.location.href="#"+n._activePage),console.log("Finshed loadLAst")},o.goToCar=function(){console.log("entered go to car");var e=codeLatLng(o.lat,o.long)},$(document).on("pagechange",function(e){console.log($.mobile.activePage.attr("id")),0==o.firstLoad&&o.writeToPhone("_activePage",$.mobile.activePage.attr("id"))}),o.init=function(){var e;o.devicesMap=[],o.firstLoad=!0,o.angularLoaded=!0,console.log("coucou angular"),o.currentData={},o.key="",o.value="",o.lat="",o.long="",o.getDeviceName(),o.loadLastCurrentData(),o.bluetoothIsEnabled(),o.bluetoothToggleOn()},o.init()}]);